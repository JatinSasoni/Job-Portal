jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      # CHANGE 1: We only output the "safe" part (the version tag)
      deploy_tag: ${{ steps.set-tags.outputs.short_sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tags
        id: set-tags
        run: |
          # Calculate the safe, unique tag
          SHA=${GITHUB_SHA::8}
          TAG_SUFFIX="sha-${SHA}"

          # Output ONLY the suffix to Github (Safe!)
          echo "short_sha=$TAG_SUFFIX" >> $GITHUB_OUTPUT

          # Set local variables for this job's internal use (Build steps)
          echo "FRONT_TAG=jatinsasoni/job-portal-client:$TAG_SUFFIX" >> $GITHUB_ENV
          echo "BACK_TAG=jatinsasoni/job-portal-server:$TAG_SUFFIX" >> $GITHUB_ENV
          echo "WORKER_TAG=jatinsasoni/job-portal-worker:$TAG_SUFFIX" >> $GITHUB_ENV

      # ... (Docker Login Step remains the same) ...

      - name: Build and push frontend
        uses: docker/build-push-action@v4
        with:
          context: ./client
          push: true
          # Use the Env var we set above
          tags: |
            ${{ env.FRONT_TAG }}
            ${{ secrets.DOCKER_USERNAME }}/job-portal-client:latest
          build-args: |
            VITE_API_URI=${{ secrets.VITE_API_URI }}

      # ... (Repeat similar logic for Backend and Worker using env.BACK_TAG etc) ...

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      # ... (SSH setup steps remain the same) ...

      - name: Run remote (EC2) deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            set -e
            cd ~/deploy
            mv deploy.env ../app/.env
            chmod 600 ../app/.env

            # CHANGE 2: Reconstruct the full image name here using the safe tag
            # We assume the username is 'jatinsasoni' based on your script, 
            # or you can use ${{ secrets.DOCKER_USERNAME }} if you pass it in via 'envs'

            TAG="${{ needs.build-and-push.outputs.deploy_tag }}"

            cat <<EOF > docker-compose.yml
            version: '3.8'
            services:
              frontend:
                image: jatinsasoni/job-portal-client:${TAG} 
                ports:
                  - "80:80"
                restart: unless-stopped
              server:
                image: jatinsasoni/job-portal-server:${TAG}
                env_file: ../app/.env
                ports:
                  - "8000:8000"
                restart: unless-stopped
              worker:
                image: jatinsasoni/job-portal-worker:${TAG}
                env_file: ../app/.env
                restart: unless-stopped
            EOF

            docker compose down
            docker compose pull
            docker compose up -d
